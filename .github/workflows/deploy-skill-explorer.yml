name: Deploy Skill Explorer (Fresh Install)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'demo repo branch to deploy'
        required: false
        default: 'main'
        type: string
      ploinky_branch:
        description: 'Ploinky branch to use'
        required: false
        default: 'master'
        type: string
      workspace_name:
        description: 'Workspace directory name on the remote host'
        required: false
        default: 'testSkillExplorer'
        type: string
      router_port:
        description: 'Router port on the remote host'
        required: false
        default: '8080'
        type: string

env:
  SSH_USER: ${{ vars.SSH_USER || 'admin' }}
  SSH_HOST: ${{ vars.SSH_HOST || '193.180.209.191' }}

jobs:
  deploy:
    name: Fresh Deploy to Remote Host
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch || 'main' }}
          fetch-depth: 0

      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "${{ env.SSH_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Install prerequisites on remote
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key "${{ env.SSH_USER }}@${{ env.SSH_HOST }}" 'bash -s' << 'PREREQ'
          set -eo pipefail
          echo "[deploy] Installing prerequisites..."

          if command -v dnf >/dev/null 2>&1; then
            PKG_MGR="dnf"
            PKG_INSTALL="sudo dnf install -y"
            PKG_UPDATE="sudo dnf check-update || true"
          elif command -v yum >/dev/null 2>&1; then
            PKG_MGR="yum"
            PKG_INSTALL="sudo yum install -y"
            PKG_UPDATE="sudo yum check-update || true"
          elif command -v apt-get >/dev/null 2>&1; then
            PKG_MGR="apt"
            PKG_INSTALL="sudo apt-get install -y -qq"
            PKG_UPDATE="sudo apt-get update -qq"
          else
            echo "[deploy] ERROR: No supported package manager found (dnf, yum, or apt-get)"
            exit 1
          fi

          echo "[deploy] Using package manager: $PKG_MGR"
          $PKG_UPDATE || true

          $PKG_INSTALL git curl jq tmux python3 ca-certificates || true
          if ! command -v podman >/dev/null 2>&1; then
            echo "[deploy] Installing podman..."
            $PKG_INSTALL podman
          fi
          if ! command -v node >/dev/null 2>&1; then
            echo "[deploy] Installing Node.js..."
            if [ "$PKG_MGR" = "apt" ]; then
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            else
              curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -
              $PKG_INSTALL nodejs
            fi
          fi
          loginctl enable-linger "$(whoami)" 2>/dev/null || true

          echo "[deploy] Prerequisites installed."
          node --version
          npm --version
          podman --version
          PREREQ

      - name: Install Ploinky
        env:
          PLOINKY_BRANCH: ${{ inputs.ploinky_branch || 'master' }}
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key "${{ env.SSH_USER }}@${{ env.SSH_HOST }}" "PLOINKY_BRANCH='$PLOINKY_BRANCH' bash -s" << 'PLOINKY'
          set -euo pipefail
          echo "[deploy] Installing Ploinky..."

          PLOINKY_DIR="$HOME/ploinky"
          if [ -d "$PLOINKY_DIR/.git" ]; then
            cd "$PLOINKY_DIR"
            git reset --hard HEAD
            git clean -fd
            git fetch origin
            git checkout "${PLOINKY_BRANCH:-master}"
            git reset --hard "origin/${PLOINKY_BRANCH:-master}"
          else
            rm -rf "$PLOINKY_DIR"
            git clone --branch "${PLOINKY_BRANCH:-master}" https://github.com/outfinityresearch/ploinky.git "$PLOINKY_DIR"
            cd "$PLOINKY_DIR"
          fi

          npm install

          mkdir -p "$HOME/.local/bin"
          ln -sf "$PLOINKY_DIR/bin/ploinky" "$HOME/.local/bin/ploinky"
          ln -sf "$PLOINKY_DIR/bin/p-cli" "$HOME/.local/bin/p-cli"
          if ! grep -q 'ploinky/bin' "$HOME/.bashrc" 2>/dev/null; then
            echo 'export PATH="$HOME/ploinky/bin:$HOME/.local/bin:$PATH"' >> "$HOME/.bashrc"
          fi
          echo "[deploy] Ploinky ready."
          PLOINKY

      - name: Setup workspace and start skill-explorer
        env:
          WORKSPACE: ${{ inputs.workspace_name || vars.SKILL_EXPLORER_WORKSPACE || 'testSkillExplorer' }}
          DEMO_BRANCH: ${{ inputs.branch || 'main' }}
          ROUTER_PORT: ${{ inputs.router_port || vars.SKILL_EXPLORER_ROUTER_PORT || '8080' }}
        run: |
          ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=30 -o ServerAliveCountMax=10 -i ~/.ssh/deploy_key "${{ env.SSH_USER }}@${{ env.SSH_HOST }}" "WORKSPACE='$WORKSPACE' DEMO_BRANCH='$DEMO_BRANCH' ROUTER_PORT='$ROUTER_PORT' bash -s" << 'DEPLOY'
          set -euo pipefail
          export PATH="$HOME/ploinky/bin:$HOME/.local/bin:$PATH"

          WORK_DIR="$HOME/$WORKSPACE"
          mkdir -p "$WORK_DIR"
          cd "$WORK_DIR"

          # Anchor workspace root (avoid parent .ploinky capture)
          if [ ! -d "$WORK_DIR/.ploinky" ]; then
            mkdir -p "$WORK_DIR/.ploinky/repos"
            [ -f "$WORK_DIR/.ploinky/agents" ] || echo '{}' > "$WORK_DIR/.ploinky/agents"
            [ -f "$WORK_DIR/.ploinky/enabled_repos.json" ] || echo '[]' > "$WORK_DIR/.ploinky/enabled_repos.json"
            [ -f "$WORK_DIR/.ploinky/.secrets" ] || echo '# Ploinky secrets' > "$WORK_DIR/.ploinky/.secrets"
          fi

          echo "[deploy] Adding demo repo (branch: $DEMO_BRANCH)..."
          ploinky add repo demo https://github.com/PloinkyRepos/demo.git "$DEMO_BRANCH" || true
          ploinky enable repo demo

          # Configure defaults
          ploinky var PLOINKY_CODE_WRITABLE "1" || true
          ploinky var PLOINKY_ROUTER_URL "http://host.containers.internal:${ROUTER_PORT}" || true
          ploinky var ASSISTOS_FS_ROOT "$WORK_DIR/.ploinky/repos/demo/skill-explorer/.AchillesSkills" || true

          mkdir -p "$WORK_DIR/logs"
          echo "[deploy] Starting skill-explorer..."
          nohup ploinky start skill-explorer "$ROUTER_PORT" > "$WORK_DIR/logs/deploy-start.log" 2>&1 &

          echo "[deploy] Waiting for router to come up..."
          # On a fresh deploy, `ploinky start` may need several minutes to install
          # OS packages + npm dependencies for multiple agents.
          sleep 10
          for i in $(seq 1 180); do
            code=$(curl -s -o /dev/null -w "%{http_code}" "http://127.0.0.1:${ROUTER_PORT}/dashboard" || true)
            if [ "$code" = "200" ] || [ "$code" = "302" ]; then
              echo "[deploy] Router is responding (HTTP $code)"
              break
            fi
            if [ "$i" = "180" ]; then
              echo "[deploy] WARNING: router did not respond in time"
              tail -100 "$WORK_DIR/logs/deploy-start.log" || true
              exit 1
            fi
            sleep 2
          done

          echo "[deploy] Containers:"
          podman ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | head -80

          echo "[deploy] Deployment complete."
          DEPLOY

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key
